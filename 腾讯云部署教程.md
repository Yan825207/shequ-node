# shequ-node è…¾è®¯äº‘æœåŠ¡å™¨éƒ¨ç½²æ•™ç¨‹

## ç›®å½•
1. [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
2. [æœåŠ¡å™¨é…ç½®](#æœåŠ¡å™¨é…ç½®)
3. [é¡¹ç›®ä¸Šä¼ ](#é¡¹ç›®ä¸Šä¼ )
4. [Dockeréƒ¨ç½²](#dockeréƒ¨ç½²)
5. [Nginxåå‘ä»£ç†](#nginxåå‘ä»£ç†)
6. [åŸŸåé…ç½®](#åŸŸåé…ç½®)
7. [å®‰å…¨é…ç½®](#å®‰å…¨é…ç½®)
8. [ç›‘æ§ä¸ç»´æŠ¤](#ç›‘æ§ä¸ç»´æŠ¤)

---

## å‡†å¤‡å·¥ä½œ

### 1. è´­ä¹°è…¾è®¯äº‘æœåŠ¡å™¨
- **æ¨èé…ç½®**ï¼š
  - CPU: 2æ ¸
  - å†…å­˜: 4GB
  - ç¡¬ç›˜: 40GB SSD
  - æ“ä½œç³»ç»Ÿ: Ubuntu 22.04 LTS æˆ– CentOS 7.9
  - å¸¦å®½: 3Mbps æˆ–æ›´é«˜

### 2. æœåŠ¡å™¨åˆå§‹åŒ–
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y  # Ubuntu
# æˆ–
sudo yum update -y  # CentOS

# å®‰è£…åŸºç¡€å·¥å…·
sudo apt install -y curl wget git vim  # Ubuntu
# æˆ–
sudo yum install -y curl wget git vim  # CentOS
```

### 3. å®‰è£…Dockerå’ŒDocker Compose

#### TencentOSç³»ç»Ÿï¼ˆè…¾è®¯äº‘æœåŠ¡å™¨ï¼‰
**é‡è¦æç¤º**ï¼šTencentOS æ˜¯è…¾è®¯äº‘åŸºäº CentOS å¼€å‘çš„å‘è¡Œç‰ˆï¼ŒDocker å®˜æ–¹å®‰è£…è„šæœ¬ä¸æ”¯æŒ TencentOSï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

**æ–¹æ³•1ï¼šä½¿ç”¨ CentOS ä»“åº“å®‰è£…ï¼ˆæ¨èï¼‰**
```bash
# 1. å¸è½½æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine

# 2. å®‰è£…ä¾èµ–åŒ…
sudo yum install -y yum-utils device-mapper-persistent-data lvm2

# 3. æ·»åŠ  Docker ä»“åº“ï¼ˆä½¿ç”¨ CentOS 7 çš„ä»“åº“ï¼‰
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 4. å®‰è£… Docker
sudo yum install -y docker-ce docker-ce-cli containerd.io

# 5. å¯åŠ¨ Docker
sudo systemctl start docker
sudo systemctl enable docker

# 6. éªŒè¯å®‰è£…
docker --version
```

**æ–¹æ³•2ï¼šä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæºï¼ˆå¦‚æœæ–¹æ³•1å¤±è´¥ï¼‰**
```bash
# 1. å¸è½½æ—§ç‰ˆæœ¬
sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine

# 2. å®‰è£…ä¾èµ–
sudo yum install -y yum-utils device-mapper-persistent-data lvm2

# 3. æ·»åŠ é˜¿é‡Œäº‘ Docker é•œåƒæº
sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

# 4. å®‰è£… Docker
sudo yum install -y docker-ce docker-ce-cli containerd.io

# 5. å¯åŠ¨ Docker
sudo systemctl start docker
sudo systemctl enable docker

# 6. éªŒè¯
docker --version
```

**æ–¹æ³•3ï¼šæ‰‹åŠ¨ä¸‹è½½ RPM åŒ…å®‰è£…ï¼ˆæœ€å¯é ï¼‰**
```bash
# 1. åˆ›å»ºä¸´æ—¶ç›®å½•
mkdir -p ~/docker-packages
cd ~/docker-packages

# 2. ä¸‹è½½ Docker CE çš„ RPM åŒ…ï¼ˆæ ¹æ®ç³»ç»Ÿæ¶æ„é€‰æ‹©ï¼‰
# ä¸‹è½½ containerd.io
sudo yum install -y https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.6.33-3.1.el7.x86_64.rpm

# ä¸‹è½½ docker-ce-cli
sudo yum install -y https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-cli-26.1.4-1.el7.x86_64.rpm

# ä¸‹è½½ docker-ce
sudo yum install -y https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-26.1.4-1.el7.x86_64.rpm

# 3. å¯åŠ¨ Docker
sudo systemctl start docker
sudo systemctl enable docker

# 4. éªŒè¯
docker --version
```

**é…ç½® Docker é•œåƒåŠ é€Ÿå™¨ï¼ˆæ¨èï¼‰**
```bash
# åˆ›å»º Docker é…ç½®ç›®å½•
sudo mkdir -p /etc/docker

# é…ç½®é•œåƒåŠ é€Ÿå™¨
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://mirror.ccs.tencentyun.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
EOF

# é‡å¯ Docker
sudo systemctl daemon-reload
sudo systemctl restart docker
```

**å®‰è£… Docker Compose**
```bash
# ä¸‹è½½ Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# æ·»åŠ æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker-compose --version
```

**éªŒè¯å®Œæ•´å®‰è£…**
```bash
# æ£€æŸ¥ Docker ç‰ˆæœ¬
docker --version

# æ£€æŸ¥ Docker Compose ç‰ˆæœ¬
docker-compose --version

# æ£€æŸ¥ Docker æœåŠ¡çŠ¶æ€
sudo systemctl status docker

# è¿è¡Œæµ‹è¯•å®¹å™¨
docker run hello-world
```

å¦‚æœçœ‹åˆ° "Hello from Docker!" çš„æ¶ˆæ¯ï¼Œè¯´æ˜ Docker å®‰è£…æˆåŠŸï¼

#### Ubuntuç³»ç»Ÿ
```bash
# å®‰è£…Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# å¯åŠ¨DockeræœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker

# å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°dockerç»„
sudo usermod -aG docker $USER

# å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

#### CentOSç³»ç»Ÿ
```bash
# å®‰è£…Docker
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io

# å¯åŠ¨DockeræœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker

# å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

---

## æœåŠ¡å™¨é…ç½®

### 1. é…ç½®é˜²ç«å¢™
```bash
# Ubuntu (UFW)
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 5000/tcp  # åº”ç”¨ç«¯å£
sudo ufw enable

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --reload
```

### 2. è…¾è®¯äº‘å®‰å…¨ç»„é…ç½®
ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°ï¼Œé…ç½®å®‰å…¨ç»„è§„åˆ™ï¼š
- **å…¥ç«™è§„åˆ™**ï¼š
  - TCP:22 (SSH) - æ¥æº: æ‚¨çš„IP
  - TCP:80 (HTTP) - æ¥æº: 0.0.0.0/0
  - TCP:443 (HTTPS) - æ¥æº: 0.0.0.0/0
  - TCP:5000 (åº”ç”¨) - æ¥æº: 0.0.0.0/0 æˆ–æŒ‡å®šIP

---

## é¡¹ç›®ä¸Šä¼ 

### 1. ä½¿ç”¨SCPä¸Šä¼ é¡¹ç›®
```bash
# åœ¨æœ¬åœ°Windows PowerShellä¸­æ‰§è¡Œ
scp -r C:\Users\20525\Desktop\node\shequ-node root@your_server_ip:/root/
```

### 2. æˆ–ä½¿ç”¨Gitå…‹éš†
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /root
git clone <your_repository_url> shequ-node
cd shequ-node
```

### 3. é…ç½®ç¯å¢ƒå˜é‡
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
cd /root/shequ-node
cp .env.example .env  # å¦‚æœæœ‰ç¤ºä¾‹æ–‡ä»¶

# ç¼–è¾‘.envæ–‡ä»¶
vim .env
```

`.env` æ–‡ä»¶å†…å®¹ï¼š
```env
# æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼ˆä½¿ç”¨Neonäº‘æ•°æ®åº“ï¼‰
DB_NAME=shequ
DB_USER=neondb_owner
DB_PASSWORD=npg_lxN2uHQYSiZ5
DB_HOST=ep-little-credit-a4ljft2f-pooler.us-east-1.aws.neon.tech
DB_PORT=5432

# æœåŠ¡å™¨é…ç½®
PORT=5000
HOST=0.0.0.0

# JWTå¯†é’¥ï¼ˆå»ºè®®ä¿®æ”¹ä¸ºæ›´å®‰å…¨çš„éšæœºå­—ç¬¦ä¸²ï¼‰
JWT_SECRET=your_secure_jwt_secret_key_change_this_in_production
JWT_EXPIRES_IN=7d

# è¿è¡Œç¯å¢ƒ
NODE_ENV=production
```

**é‡è¦æç¤º**ï¼š
- ä¿®æ”¹`JWT_SECRET`ä¸ºå¼ºå¯†ç 
- ç¡®ä¿æ•°æ®åº“è¿æ¥ä¿¡æ¯æ­£ç¡®
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å·¥å…·

---

## Dockeréƒ¨ç½²

### 1. æ„å»ºå¹¶å¯åŠ¨å®¹å™¨
```bash
cd /root/shequ-node

# æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
docker-compose up -d --build

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose ps
```

### 2. éªŒè¯éƒ¨ç½²
```bash
# æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
docker ps

# æµ‹è¯•API
curl http://localhost:5000/api/v1/health

# æˆ–
curl http://your_server_ip:5000/api/v1/health
```

é¢„æœŸå“åº”ï¼š
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "message": "æœåŠ¡å™¨è¿è¡Œæ­£å¸¸"
}
```

### 3. å¸¸ç”¨Dockerå‘½ä»¤
```bash
# åœæ­¢æœåŠ¡
docker-compose stop

# å¯åŠ¨æœåŠ¡
docker-compose start

# é‡å¯æœåŠ¡
docker-compose restart

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend

# è¿›å…¥å®¹å™¨
docker exec -it shequ-backend sh

# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats shequ-backend

# åˆ é™¤å®¹å™¨å’Œé•œåƒ
docker-compose down
docker-compose down --rmi all
```

---

## Nginxåå‘ä»£ç†

### 1. å®‰è£…Nginx
```bash
# Ubuntu
sudo apt install -y nginx

# CentOS
sudo yum install -y nginx

# å¯åŠ¨Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 2. é…ç½®Nginx
åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š
```bash
sudo vim /etc/nginx/sites-available/shequ-api
```

é…ç½®å†…å®¹ï¼š
```nginx
server {
    listen 80;
    server_name your_domain.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸåæˆ–æœåŠ¡å™¨IP

    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/shequ-api-access.log;
    error_log /var/log/nginx/shequ-api-error.log;

    # å®¢æˆ·ç«¯ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 10M;

    # APIä»£ç†
    location /api/ {
        proxy_pass http://localhost:5000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # æ–‡ä»¶ä¸Šä¼ ä»£ç†
    location /uploads/ {
        proxy_pass http://localhost:5000/uploads/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # ç¼“å­˜è®¾ç½®
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://localhost:5000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}
```

### 3. å¯ç”¨é…ç½®
```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/shequ-api /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx
```

### 4. æµ‹è¯•Nginx
```bash
# æµ‹è¯•é€šè¿‡Nginxè®¿é—®
curl http://your_server_ip/api/v1/health
# æˆ–
curl http://your_domain.com/api/v1/health
```

---

## åŸŸåé…ç½®

### 1. åŸŸåè§£æ
åœ¨è…¾è®¯äº‘DNSè§£æä¸­æ·»åŠ è®°å½•ï¼š
- **è®°å½•ç±»å‹**: A
- **ä¸»æœºè®°å½•**: @ æˆ– www
- **è®°å½•å€¼**: æ‚¨çš„æœåŠ¡å™¨å…¬ç½‘IP
- **TTL**: 600

### 2. é…ç½®HTTPSï¼ˆä½¿ç”¨Let's Encryptå…è´¹è¯ä¹¦ï¼‰

#### å®‰è£…Certbot
```bash
# Ubuntu
sudo apt install -y certbot python3-certbot-nginx

# CentOS
sudo yum install -y certbot python3-certbot-nginx
```

#### è·å–SSLè¯ä¹¦
```bash
# è‡ªåŠ¨é…ç½®Nginx
sudo certbot --nginx -d your_domain.com -d www.your_domain.com

# æˆ–åªè·å–è¯ä¹¦
sudo certbot certonly --nginx -d your_domain.com -d www.your_domain.com
```

#### è‡ªåŠ¨ç»­æœŸ
```bash
# æµ‹è¯•ç»­æœŸ
sudo certbot renew --dry-run

# Certbotä¼šè‡ªåŠ¨é…ç½®ç»­æœŸä»»åŠ¡
# æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
sudo systemctl list-timers | grep certbot
```

### 3. æ›´æ–°Nginxé…ç½®æ”¯æŒHTTPS
```bash
sudo vim /etc/nginx/sites-available/shequ-api
```

æ›´æ–°åçš„é…ç½®ï¼š
```nginx
# HTTPé‡å®šå‘åˆ°HTTPS
server {
    listen 80;
    server_name your_domain.com www.your_domain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPSé…ç½®
server {
    listen 443 ssl http2;
    server_name your_domain.com www.your_domain.com;

    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/your_domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your_domain.com/privkey.pem;
    
    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/shequ-api-access.log;
    error_log /var/log/nginx/shequ-api-error.log;

    # å®¢æˆ·ç«¯ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 10M;

    # APIä»£ç†
    location /api/ {
        proxy_pass http://localhost:5000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # æ–‡ä»¶ä¸Šä¼ ä»£ç†
    location /uploads/ {
        proxy_pass http://localhost:5000/uploads/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # ç¼“å­˜è®¾ç½®
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://localhost:5000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}
```

é‡å¯Nginxï¼š
```bash
sudo nginx -t
sudo systemctl restart nginx
```

---

## å®‰å…¨é…ç½®

### 1. SSHå®‰å…¨é…ç½®
```bash
# ç¼–è¾‘SSHé…ç½®
sudo vim /etc/ssh/sshd_config

# ä¿®æ”¹ä»¥ä¸‹é…ç½®
Port 22222                    # ä¿®æ”¹é»˜è®¤ç«¯å£
PermitRootLogin no            # ç¦æ­¢rootç™»å½•
PasswordAuthentication no     # ç¦ç”¨å¯†ç ç™»å½•ï¼Œä½¿ç”¨å¯†é’¥ç™»å½•
PubkeyAuthentication yes      # å¯ç”¨å…¬é’¥è®¤è¯

# é‡å¯SSHæœåŠ¡
sudo systemctl restart sshd
```

### 2. é…ç½®é˜²ç«å¢™è§„åˆ™
```bash
# åªå…è®¸ç‰¹å®šIPè®¿é—®SSH
sudo ufw allow from your_ip_address to any port 22222

# æˆ–ä½¿ç”¨iptables
sudo iptables -A INPUT -p tcp -s your_ip_address --dport 22222 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 22222 -j DROP
```

### 3. å®‰è£…Fail2Bané˜²æ­¢æš´åŠ›ç ´è§£
```bash
# å®‰è£…Fail2Ban
sudo apt install -y fail2ban  # Ubuntu
# æˆ–
sudo yum install -y fail2ban  # CentOS

# é…ç½®Fail2Ban
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo vim /etc/fail2ban/jail.local
```

é…ç½®å†…å®¹ï¼š
```ini
[sshd]
enabled = true
port = 22222
maxretry = 3
bantime = 3600
findtime = 600
```

å¯åŠ¨Fail2Banï¼š
```bash
sudo systemctl start fail2ban
sudo systemctl enable fail2ban
```

### 4. é…ç½®è‡ªåŠ¨å®‰å…¨æ›´æ–°
```bash
# Ubuntu
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades

# CentOS
sudo yum install -y yum-cron
sudo systemctl start yum-cron
sudo systemctl enable yum-cron
```

---

## ç›‘æ§ä¸ç»´æŠ¤

### 1. å®‰è£…ç›‘æ§å·¥å…·

#### å®‰è£…htop
```bash
sudo apt install -y htop  # Ubuntu
# æˆ–
sudo yum install -y htop  # CentOS
```

#### å®‰è£…Node.jsè¿›ç¨‹ç®¡ç†å™¨PM2
```bash
# å¦‚æœéœ€è¦ç›´æ¥è¿è¡ŒNode.jsï¼ˆéDockerï¼‰
npm install -g pm2
```

### 2. é…ç½®æ—¥å¿—ç®¡ç†
```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/shequ-api

# é…ç½®æ—¥å¿—è½®è½¬
sudo vim /etc/logrotate.d/shequ-api
```

é…ç½®å†…å®¹ï¼š
```
/var/log/nginx/shequ-api-*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

### 3. è®¾ç½®ç›‘æ§è„šæœ¬
åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ¬ï¼š
```bash
sudo vim /usr/local/bin/check-api-health.sh
```

è„šæœ¬å†…å®¹ï¼š
```bash
#!/bin/bash

# APIå¥åº·æ£€æŸ¥è„šæœ¬
API_URL="http://localhost:5000/api/v1/health"
LOG_FILE="/var/log/shequ-api/health-check.log"

# æ£€æŸ¥APIå“åº”
response=$(curl -s -o /dev/null -w "%{http_code}" $API_URL)

if [ $response -eq 200 ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S') - API is healthy" >> $LOG_FILE
else
    echo "$(date '+%Y-%m-%d %H:%M:%S') - API is unhealthy (HTTP $response)" >> $LOG_FILE
    # å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆå¯é›†æˆé‚®ä»¶ã€çŸ­ä¿¡ç­‰ï¼‰
fi
```

è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š
```bash
# æ·»åŠ æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/check-api-health.sh

# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /usr/local/bin/check-api-health.sh
```

### 4. æ•°æ®åº“å¤‡ä»½ï¼ˆå¦‚æœä½¿ç”¨æœ¬åœ°æ•°æ®åº“ï¼‰
```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
sudo vim /usr/local/bin/backup-db.sh
```

è„šæœ¬å†…å®¹ï¼š
```bash
#!/bin/bash

# æ•°æ®åº“å¤‡ä»½è„šæœ¬
BACKUP_DIR="/var/backups/shequ-db"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="shequ"
DB_USER="your_db_user"
DB_PASSWORD="your_db_password"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
pg_dump -h localhost -U $DB_USER -d $DB_NAME > $BACKUP_DIR/shequ_$DATE.sql

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip $BACKUP_DIR/shequ_$DATE.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "shequ_*.sql.gz" -mtime +7 -delete

echo "Backup completed: shequ_$DATE.sql.gz"
```

è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š
```bash
# æ·»åŠ æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/backup-db.sh

# ç¼–è¾‘crontab
crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /usr/local/bin/backup-db.sh
```

### 5. Dockerå®¹å™¨ç›‘æ§
```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats --no-stream

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs --tail=100 -f backend

# è®¾ç½®å®¹å™¨æ—¥å¿—å¤§å°é™åˆ¶
# åœ¨docker-compose.ymlä¸­æ·»åŠ ï¼š
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1. å®¹å™¨æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs backend

# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker-compose config

# é‡æ–°æ„å»º
docker-compose up -d --build --force-recreate
```

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec -it shequ-backend sh
# åœ¨å®¹å™¨å†…æ‰§è¡Œ
ping $DB_HOST
telnet $DB_HOST $DB_PORT

# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker exec shequ-backend env | grep DB_
```

### 3. Nginx 502é”™è¯¯
```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
docker-compose ps

# æ£€æŸ¥Nginxé…ç½®
sudo nginx -t

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/shequ-api-error.log
```

### 4. ç«¯å£è¢«å ç”¨
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo netstat -tulpn | grep :5000

# æˆ–ä½¿ç”¨sså‘½ä»¤
sudo ss -tulpn | grep :5000
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. Dockerä¼˜åŒ–
```yaml
# åœ¨docker-compose.ymlä¸­æ·»åŠ èµ„æºé™åˆ¶
services:
  backend:
    # ... å…¶ä»–é…ç½®
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
```

### 2. Nginxä¼˜åŒ–
```nginx
# åœ¨httpå—ä¸­æ·»åŠ 
http {
    # å¼€å¯gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;
    
    # è¿æ¥ä¼˜åŒ–
    worker_processes auto;
    worker_connections 1024;
    keepalive_timeout 65;
}
```

### 3. åº”ç”¨å±‚ä¼˜åŒ–
- ä½¿ç”¨Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
- å®ç°æ•°æ®åº“è¿æ¥æ± 
- æ·»åŠ CDNåŠ é€Ÿé™æ€èµ„æº
- å®ç°APIé™æµå’Œç†”æ–­

---

## æ€»ç»“

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæ‚¨å·²ç»æˆåŠŸå°†shequ-nodeé¡¹ç›®éƒ¨ç½²åˆ°è…¾è®¯äº‘æœåŠ¡å™¨ã€‚å…³é”®æ­¥éª¤åŒ…æ‹¬ï¼š

1. âœ… æœåŠ¡å™¨å‡†å¤‡å’ŒDockerå®‰è£…
2. âœ… é¡¹ç›®ä¸Šä¼ å’Œç¯å¢ƒé…ç½®
3. âœ… Dockerå®¹å™¨åŒ–éƒ¨ç½²
4. âœ… Nginxåå‘ä»£ç†é…ç½®
5. âœ… HTTPSå®‰å…¨é…ç½®
6. âœ… å®‰å…¨åŠ å›ºå’Œç›‘æ§è®¾ç½®

### ä¸‹ä¸€æ­¥å»ºè®®

1. **å‰ç«¯éƒ¨ç½²**ï¼šå°†shequ-reactå‰ç«¯é¡¹ç›®éƒ¨ç½²åˆ°æœåŠ¡å™¨æˆ–CDN
2. **CI/CDé…ç½®**ï¼šè®¾ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹
3. **ç›‘æ§å‘Šè­¦**ï¼šé›†æˆPrometheusã€Grafanaç­‰ç›‘æ§å·¥å…·
4. **è´Ÿè½½å‡è¡¡**ï¼šä½¿ç”¨å¤šå°æœåŠ¡å™¨å®ç°é«˜å¯ç”¨
5. **æ•°æ®åº“ä¼˜åŒ–**ï¼šé…ç½®è¯»å†™åˆ†ç¦»å’Œä¸»ä»å¤åˆ¶

### æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
- Dockerå®¹å™¨æ—¥å¿—ï¼š`docker-compose logs -f backend`
- Nginxæ—¥å¿—ï¼š`/var/log/nginx/shequ-api-*.log`
- ç³»ç»Ÿæ—¥å¿—ï¼š`/var/log/syslog` æˆ– `journalctl -u docker`

ç¥æ‚¨éƒ¨ç½²é¡ºåˆ©ï¼ğŸš€
